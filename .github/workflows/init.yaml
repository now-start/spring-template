name: Project Initialization

on:
  push:
    branches: [ main ]

jobs:
  init:
    # 템플릿 레포지토리 자체에서는 실행되지 않도록 설정
    if: github.repository != 'now-start/spring-template'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rename Project and Package
        run: |
          # 1. 변수 설정
          REPO_NAME=${{ github.event.repository.name }}
          # 하이픈(-)이나 공백을 제거한 패키지용 이름 생성 (예: my-project -> myproject)
          CLEAN_NAME=$(echo "$REPO_NAME" | sed 's/[-_ ]//g' | tr '[:upper:]' '[:lower:]')
          GROUP_NAME="org.nowstart" # 필요시 수정 가능
          NEW_PACKAGE="$GROUP_NAME.$CLEAN_NAME"
          OLD_PACKAGE="org.nowstart.spring"
          
          echo "Repo Name: $REPO_NAME"
          echo "Clean Name: $CLEAN_NAME"
          echo "New Package: $NEW_PACKAGE"

          # 2. 프로젝트 이름 수정
          sed -i "s/rootProject.name = 'spring'/rootProject.name = '$REPO_NAME'/g" settings.gradle
          sed -i "s/name: spring/name: $REPO_NAME/g" src/main/resources/application.yaml
          
          # 3. Swagger 설정 수정
          sed -i "s/title(\"Spring Template\")/title(\"$REPO_NAME API\")/g" src/main/java/org/nowstart/spring/config/SwaggerConfig.java
          sed -i "s/description(\"Spring 관련 API 문서\")/description(\"$REPO_NAME 프로젝트의 API 문서입니다.\")/g" src/main/java/org/nowstart/spring/config/SwaggerConfig.java

          # 4. 패키지명 변경 (파일 내용)
          # Java 파일 내의 package 및 import 구문 수정
          OLD_PKG_ESC=$(echo $OLD_PACKAGE | sed 's/\./\\\./g')
          find src -type f -name "*.java" -exec sed -i "s/package $OLD_PKG_ESC/package $NEW_PACKAGE/g" {} +
          find src -type f -name "*.java" -exec sed -i "s/import $OLD_PKG_ESC/import $NEW_PACKAGE/g" {} +

          # 5. 디렉토리 구조 변경
          OLD_PATH=$(echo $OLD_PACKAGE | sed 's/\./\//g')
          NEW_PATH=$(echo $NEW_PACKAGE | sed 's/\./\//g')
          
          # main 디렉토리 이동
          mkdir -p "src/main/java/$NEW_PATH"
          cp -r src/main/java/$OLD_PATH/* "src/main/java/$NEW_PATH/"
          rm -rf "src/main/java/org/nowstart/spring" # 기존 경로 삭제 (상위 패키지가 같을 경우 주의)
          
          # test 디렉토리 이동
          mkdir -p "src/test/java/$NEW_PATH"
          cp -r src/test/java/$OLD_PATH/* "src/test/java/$NEW_PATH/"
          rm -rf "src/test/java/org/nowstart/spring"

      - name: Commit changes and Self-destruct
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Remove this workflow file
          rm .github/workflows/init.yaml
          
          # Add all changes including the deletion
          git add .
          
          # Commit and Push
          git commit -m "Initialize project and remove initialization workflow: ${{ github.event.repository.name }}"
          git push
